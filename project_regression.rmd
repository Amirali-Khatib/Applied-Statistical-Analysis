---
title: "Regression Project"
author: "Amirali Khatib"
date: "6/19/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
In the this classification and regression project, we'll work with `players_csv` file which consist of detailed attribute for each football player. we're following 2 purpose in this project.

**Regression goal:**
We fit regression models to our data in order to predict players' value in the transfer market. So, football clubs' owners will know how much they should pay to sign a contract with a player that has a special combination of skills.

**Classification goal:**
Our purpose in fitting classification models to our data is to build a high performance classifier that be able to recommend the head coach the squad position for each player with specific sort of abilities. 

# Dataset features:
To know some more detailes and explanation about the features that exist in the data set, I recommend you to check these two link bellow:

* [Attributes expalation](https://fifauteam.com/fifa-21-attributes-guide/#:~:text=Acceleration%20is%20the%20increment%20of,alongside%20the%20Sprint%20Speed%20stat.)
* [Example : Luka Modric attributes](https://www.futbin.com/22/player/399/luka-modric)

# Intialization

## Import required libraries
```{r}
library(tidyverse)
library(MASS)
library(caret)
library(rpart)
library(rpart.plot)
library(knitr)
library(kableExtra)
library(e1071)
library(nnet)
library(pROC)
library(ellipse)
library(lares)
library(reshape2)
library(ROSE)
```
## Read dataset
```{r}
fifa = read.csv(file = 'D:\\Amirali\\University\\Applied Statistical Analysis\\R-tutorial\\Project\\players_22.csv', header = TRUE)
```
## Data pre-processing
```{r}
fifa = na.omit(fifa)
fifa = fifa %>%
  dplyr::select(-position, everything()) %>%
  dplyr::select(-value_eur, everything())
fifa1.0_reg = fifa
fifa1.0_reg[,c("sofifa_id","short_name","potential","club_name","league_name","club_jersey_number","nationality_name","weight_kg", "height_cm")] <- list(NULL)
colnames(fifa1.0_reg)
```
## Data spliting
```{r}
set.seed(23)
# test-train split
idx = sample(nrow(fifa1.0_reg), size = 0.8 * nrow(fifa1.0_reg))
fifa_trn = fifa1.0_reg[idx,]
fifa_tst = fifa1.0_reg[-idx,]

# estimation-validation split
idx1 = sample(nrow(fifa_trn), size = 0.8 * nrow(fifa_trn))
fifa_est = fifa_trn[idx1,]
fifa_val = fifa_trn[-idx1,]

# check data
length(fifa1.0_reg)
unique(fifa$position)
```
```{r}
fifa_est_c = fifa_est
fifa_est_c[,c('position')] <- list(NULL)
cormat = cor(fifa_est_c)
cormat = round(cormat,2)
```



## EDA
```{r}
melted_cormat = melt(cormat)
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0,
                       limit = c(-1,1),space = "Lab",name="Pearson\nCorrelation")
```

```{r}
corr_cross(fifa_est, max_pvalue = 0.05, top = 30)
```

```{r}
corr_var(fifa_est, value_eur, top = 30)
```


```{r}
ggplot(data = fifa_est, aes(x = position, y = value_eur, group = position, color = position))+
  geom_point(size = 4)
```


```{r}
table(fifa_est$position)
```
# RMSE Function
```{r}
rmse =function(predicted, actual){sqrt(mean((actual - predicted)^2))}
```


# Regression Models

## Linear models
### Training on estimation set
```{r}
lm_model_list = list(
  lm_1 = lm(formula = value_eur ~ ., data = fifa_est),
  lm_2 = lm(formula = value_eur ~ .^2, data = fifa_est),
  lm_3 = step(lm(formula = value_eur ~ ., data = fifa_est), trace = FALSE, direction = 'both'),
  lm_4 = lm(formula = value_eur ~ poly(overall,2)+poly(age,2)+poly(international_reputation,2)+
              poly(finishing,2)+poly(long_passing,2)+poly(ball_control,2)+
              poly(sprint_speed,2)+poly(strength,2)+poly(interceptions,2)+
              poly(vision,2)+poly(sliding_tackle,2)+poly(gk_diving,2),data = fifa_est),
  lm_5 = lm(formula = value_eur ~ poly(overall,3)+poly(age,3)+poly(international_reputation,3)+
              poly(finishing,3)+poly(long_passing,3)+poly(ball_control,3)+
              poly(sprint_speed,3)+poly(strength,3)+poly(interceptions,3)+
              poly(vision,3)+poly(sliding_tackle,3)+poly(gk_diving,3),data = fifa_est))
```

### Predict value and RMSE value of linear models
```{r}
fifa_est_lm_predicted_list = lapply(lm_model_list, predict, fifa_est)
fifa_val_lm_predicted_list = lapply(lm_model_list, predict, fifa_val)

fifa_est_lm_rmse_vector = sapply(fifa_est_lm_predicted_list, rmse, fifa_est$value_eur)
fifa_val_lm_rmse_vector = sapply(fifa_val_lm_predicted_list, rmse, fifa_val$value_eur)
```

```{r}
rmse_lm = data.frame(fifa_est_lm_rmse_vector, fifa_val_lm_rmse_vector)
colnames(rmse_lm) = c('Est','Val')
rownames(rmse_lm) = c('lm_1','lm_2','lm_3','lm_4','lm_5')
```
```{r}
rmse_lm = data.matrix(rmse_lm)
rmse_lm = melt(rmse_lm)
colnames(rmse_lm) = c('model','data_type','RMSE')

ggplot(data = rmse_lm, aes(x = model, y = RMSE,group = data_type,color = data_type))+geom_point(size = 2.5)+geom_line(size = 0.75)
```



## KNN models
### Feature scaling
#### Estimation set
```{r}
fifa_est_scaled = data.frame(rep(0,nrow(fifa_est)))
center_vec = vector()
scale_vec = vector()

for (i in 1:(length(fifa_est)-2)){
  scaled_feature = scale(fifa_est[,i])
  fifa_est_scaled[,i] = scaled_feature
  center_vec = append(center_vec, attr(scaled_feature, 'scaled:center'))
  scale_vec = append(scale_vec, attr(scaled_feature, 'scaled:scale'))
}
fifa_est_scaled[,length(fifa_est_scaled)+1] = fifa_est$position
fifa_est_scaled[,length(fifa_est_scaled)+1] = fifa_est$value_eur
colnames(fifa_est_scaled) = colnames(fifa_est)
```
#### Validation
```{r}
fifa_val_scaled = data.frame(rep(0,nrow(fifa_val)))
for (i in 1:(length(fifa_val)-2)){
  scaled_feature = scale(fifa_val[,i], scale = scale_vec[i], center = center_vec[i])
  scaled_feature = as.vector(scaled_feature) 
  fifa_val_scaled[,i] = scaled_feature}
class(scaled_feature)
fifa_val_scaled[,length(fifa_val_scaled)+1] = fifa_val$position
fifa_val_scaled[,length(fifa_val_scaled)+1] = fifa_val$value_eur
colnames(fifa_val_scaled) = colnames(fifa_val)
```

```{r}
fifa_knn_model_list = list()
k_list = seq(10,100,10)
for(i in 1:length(k_list)){fifa_knn_model_list[[i]] = knnreg(formula = value_eur ~ . ,
                                                             data = fifa_est,
                                                             k = k_list[i])}

fifa_knn_predicted_est_list = lapply(fifa_knn_model_list, predict, fifa_est)
fifa_rmse_est_list = sapply(fifa_knn_predicted_est_list, rmse, fifa_est$value_eur)

fifa_knn_predicted_val_list = lapply(fifa_knn_model_list, predict, fifa_val)
fifa_rmse_val_list = sapply(fifa_knn_predicted_val_list, rmse, fifa_val$value_eur)


fifa_scaled_knn_model_list = list()
for(i in 1:length(k_list)){fifa_scaled_knn_model_list[[i]] = knnreg(formula = value_eur ~ . ,
                                                                    data = fifa_est_scaled,
                                                                    k =  k_list[i])}

fifa_scaled_knn_predicted_est_list = lapply(fifa_scaled_knn_model_list, predict, fifa_est_scaled)
fifa_scaled_knn_rmse_est_list = sapply(fifa_scaled_knn_predicted_est_list, rmse, fifa_est_scaled$value_eur)

fifa_scaled_knn_predicted_val_list = lapply(fifa_scaled_knn_model_list, predict, fifa_val_scaled)
fifa_scaled_knn_rmse_val_list = sapply(fifa_scaled_knn_predicted_val_list, rmse, fifa_val_scaled$value_eur)
```

```{r}
knn_report = data.frame(fifa_rmse_est_list,fifa_rmse_val_list,
                        fifa_scaled_knn_rmse_est_list, fifa_scaled_knn_rmse_val_list)

colnames(knn_report) = c('est','val','scaled_est','scaled_val')
rownames(knn_report) = c('k=10','k=20','k=30','k=40','k=50','k=60','k=70','k=80','k=90','k=100')
knn_report
```

```{r}
knn_report = melt(data.matrix(knn_report))
colnames(knn_report) = c('k', 'data_type','RMSE')
ggplot(data = knn_report, aes(x = k, y = RMSE, group = data_type, color = data_type))+geom_point(size = 2)+geom_line(size = 0.75)
```

## Regression tree models
```{r}
cp_list = c(0.1,0.01,0.001)
minsplit_list = seq(10,100,30)

fifa_regtr_list = list(
  tr1 = rpart(value_eur ~ ., data = fifa_est, cp = 0.1, minsplit = 10),
  tr2 = rpart(value_eur ~ ., data = fifa_est, cp = 0.1, minsplit = 40), 
  tr3 = rpart(value_eur ~ ., data = fifa_est, cp = 0.1, minsplit = 70),
  tr4 = rpart(value_eur ~ ., data = fifa_est, cp = 0.1, minsplit = 100),
  tr5 = rpart(value_eur ~ ., data = fifa_est, cp = 0.01, minsplit = 10),
  tr6 = rpart(value_eur ~ ., data = fifa_est, cp = 0.01, minsplit = 40),
  tr7 = rpart(value_eur ~ ., data = fifa_est, cp = 0.01, minsplit = 70),
  tr8 = rpart(value_eur ~ ., data = fifa_est, cp = 0.01, minsplit = 100),
  tr9 = rpart(value_eur ~ ., data = fifa_est, cp = 0.001, minsplit = 10),
  tr10 = rpart(value_eur ~ ., data = fifa_est, cp = 0.001, minsplit = 40),
  tr11 = rpart(value_eur ~ ., data = fifa_est, cp = 0.001, minsplit = 70),
  tr12 = rpart(value_eur ~ ., data = fifa_est, cp = 0.001, minsplit = 100))


fifa_regtr_predicted_est_list = lapply(fifa_regtr_list, predict, fifa_est)
fifa_regtr_rmse_est_list = sapply(fifa_regtr_predicted_est_list, rmse, fifa_est$value_eur)

fifa_regtr_predicted_val_list = lapply(fifa_regtr_list, predict, fifa_val)
fifa_regtr_rmse_val_list = sapply(fifa_regtr_predicted_val_list, rmse, fifa_val$value_eur)

regtr_report = data.frame(fifa_regtr_rmse_est_list,fifa_regtr_rmse_val_list)
colnames(regtr_report) = c('Est','Val')
rownames(regtr_report) = c('tr1','tr2','tr3','tr4','tr5','tr6',
                           'tr7','tr8','tr9','tr10','tr11','tr12')
regtr_report
```

```{r}
regtr_report = melt(data.matrix(regtr_report))
colnames(regtr_report) = c('model','data_type','RMSE')
ggplot(data = regtr_report, aes(x = model, y = RMSE, group = data_type, color = data_type))+
  geom_point(size = 2)+
  geom_line(size = 0.75)
```
```{r}
rpart.plot(fifa_regtr_list$tr9)
```

### Fit final model on train data and calculate RMSE in predicting test set.
```{r}
tr = rpart(value_eur ~ ., data = fifa_trn, cp = 0.001, minsplit = 10)
rmse(predict(tr, fifa_tst), fifa_tst$value_eur)
rpart.plot(tr)
```

