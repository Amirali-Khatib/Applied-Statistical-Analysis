---
title: "Classification project"
author: "Amirali Khatib"
date: "7/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Intialization

## Import required libraries
```{r}
library(tidyverse)
library(MASS)
library(caret)
library(rpart)
library(rpart.plot)
library(knitr)
library(kableExtra)
library(e1071)
library(nnet)
library(pROC)
library(ellipse)
library(lares)
library(reshape2)
library(ROSE)
```
## Read dataset
```{r}
fifa = read.csv(file = 'D:\\Amirali\\University\\Applied Statistical Analysis\\R-tutorial\\Project\\players_22.csv', header = TRUE)
nrow(fifa)
```
## Data pre-processing
```{r}
fifa = na.omit(fifa)
nrow(fifa)
fifa = fifa %>%
  dplyr::select(-position, everything()) %>%
  dplyr::select(-value_eur, everything())
fifa1.0_reg = fifa
fifa1.0_reg[,c("sofifa_id","short_name","potential","club_name","league_name","club_jersey_number","nationality_name","weight_kg", "height_cm")] <- list(NULL)
```

## Data spliting
```{r}
set.seed(23)
# test-train split
idx = sample(nrow(fifa1.0_reg), size = 0.8 * nrow(fifa1.0_reg))
fifa_trn = fifa1.0_reg[idx,]
fifa_tst = fifa1.0_reg[-idx,]

# estimation-validation split
idx1 = sample(nrow(fifa_trn), size = 0.8 * nrow(fifa_trn))
fifa_est = fifa_trn[idx1,]
fifa_val = fifa_trn[-idx1,]
```

### Feature scaling
#### Estimation set
```{r}
fifa_est_scaled = data.frame(rep(0,nrow(fifa_est)))
center_vec = vector()
scale_vec = vector()

for (i in 1:(length(fifa_est)-2)){
  scaled_feature = scale(fifa_est[,i])
  fifa_est_scaled[,i] = scaled_feature
  center_vec = append(center_vec, attr(scaled_feature, 'scaled:center'))
  scale_vec = append(scale_vec, attr(scaled_feature, 'scaled:scale'))
}
fifa_est_scaled[,length(fifa_est_scaled)+1] = fifa_est$position
fifa_est_scaled[,length(fifa_est_scaled)+1] = fifa_est$value_eur
colnames(fifa_est_scaled) = colnames(fifa_est)
```
#### Validation
```{r}
fifa_val_scaled = data.frame(rep(0,nrow(fifa_val)))
for (i in 1:(length(fifa_val)-2)){
  scaled_feature = scale(fifa_val[,i], scale = scale_vec[i], center = center_vec[i])
  scaled_feature = as.vector(scaled_feature) 
  fifa_val_scaled[,i] = scaled_feature}
class(scaled_feature)
fifa_val_scaled[,length(fifa_val_scaled)+1] = fifa_val$position
fifa_val_scaled[,length(fifa_val_scaled)+1] = fifa_val$value_eur
colnames(fifa_val_scaled) = colnames(fifa_val)
```
#### Trainig
```{r}
fifa_trn_scaled = data.frame(rep(0,nrow(fifa_trn)))
center_vec = vector()
scale_vec = vector()
for (i in 1:(length(fifa_trn)-2)){
  scaled_feature = scale(fifa_trn[,i])
  fifa_trn_scaled[,i] = scaled_feature
  center_vec = append(center_vec, attr(scaled_feature, 'scaled:center'))
  scale_vec = append(scale_vec, attr(scaled_feature, 'scaled:scale'))
}

fifa_trn_scaled[,length(fifa_trn_scaled)+1] = fifa_trn$position
fifa_trn_scaled[,length(fifa_trn_scaled)+1] = fifa_trn$value_eur
colnames(fifa_trn_scaled) = colnames(fifa_trn)
```
#### Test
```{r}
fifa_tst_scaled  = data.frame(rep(0,nrow(fifa_tst)))
for (i in 1:(length(fifa_tst)-2)){
  scaled_feature = scale(fifa_tst[,i], scale = scale_vec[i], center = center_vec[i])
  scaled_feature = as.vector(scaled_feature) 
  fifa_tst_scaled[,i] = scaled_feature}

fifa_tst_scaled[,length(fifa_tst_scaled)+1] = fifa_tst$position
fifa_tst_scaled[,length(fifa_tst_scaled)+1] = fifa_tst$value_eur
colnames(fifa_tst_scaled) = colnames(fifa_tst)
```
# Classification Models
## Classfication Evaluation Function
```{r}
sens_spec_claculator = function(predicted, actual, class){
  tp = sum(predicted == class[1] & actual == class[1])
  fn = sum(predicted == class[2] & actual == class[1])
  fp = sum(predicted == class[1] & actual == class[2])
  tn = sum(predicted == class[2] & actual == class[2])
  Sensitivity = tp / (tp + fn)
  Precision = tp / (tp + fp)
  F1_score = 2 * Sensitivity * Precision / (Sensitivity+Precision)
  Accuracy = (tp+tn)/(tp+tn+fp+fn)
  return(list(sensitivity = Sensitivity,
              precision = Precision,
              f1_score = F1_score,
              accuracy = Accuracy))}
```

# Miss classification function
```{r}
miss_class = function(predicted, actual){mean(predicted != actual)}
```

## data preprocessing
### Non_scaled data
```{r}
fifa_est = subset(fifa_est, select = -c(value_eur))
fifa_val = subset(fifa_val, select = -c(value_eur))
fifa_trn = subset(fifa_trn, select = -c(value_eur))
fifa_tst = subset(fifa_tst, select = -c(value_eur))

fifa_est$position[fifa_est$position == 'defender' | fifa_est$position == 'goalkeeper'] = 'def_gk'
fifa_est$position[fifa_est$position == 'midfielder' | fifa_est$position == 'forward'] = 'mid_for'

fifa_val$position[fifa_val$position == 'defender' | fifa_val$position == 'goalkeeper'] = 'def_gk'
fifa_val$position[fifa_val$position == 'midfielder' | fifa_val$position == 'forward'] = 'mid_for'

fifa_trn$position[fifa_trn$position == 'defender' | fifa_trn$position == 'goalkeeper'] = 'def_gk'
fifa_trn$position[fifa_trn$position == 'midfielder' | fifa_trn$position == 'forward'] = 'mid_for'

fifa_tst$position[fifa_tst$position == 'defender' | fifa_tst$position == 'goalkeeper'] = 'def_gk'
fifa_tst$position[fifa_tst$position == 'midfielder' | fifa_tst$position == 'forward'] = 'mid_for'

fifa_est$position = as.factor(fifa_est$position)
fifa_val$position = as.factor(fifa_val$position)
fifa_trn$position = as.factor(fifa_trn$position)
fifa_tst$position = as.factor(fifa_tst$position)
```
### Scaled data
```{r}
fifa_est_scaled = subset(fifa_est_scaled, select = -c(value_eur))
fifa_val_scaled = subset(fifa_val_scaled, select = -c(value_eur))
fifa_trn_scaled = subset(fifa_trn_scaled, select = -c(value_eur))
fifa_tst_scaled = subset(fifa_tst_scaled, select = -c(value_eur))


fifa_est_scaled$position[fifa_est_scaled$position == 'defender' | fifa_est_scaled$position == 'goalkeeper'] = 'def_gk'
fifa_est_scaled$position[fifa_est_scaled$position == 'midfielder' | fifa_est_scaled$position == 'forward'] = 'mid_for'

fifa_val_scaled$position[fifa_val_scaled$position == 'defender' | fifa_val_scaled$position == 'goalkeeper'] = 'def_gk'
fifa_val_scaled$position[fifa_val_scaled$position == 'midfielder' | fifa_val_scaled$position == 'forward'] = 'mid_for'

fifa_trn_scaled$position[fifa_trn_scaled$position == 'defender' | fifa_trn_scaled$position == 'goalkeeper'] = 'def_gk'
fifa_trn_scaled$position[fifa_trn_scaled$position == 'midfielder' | fifa_trn_scaled$position == 'forward'] = 'mid_for'
  
fifa_tst_scaled$position[fifa_tst_scaled$position == 'defender' | fifa_tst_scaled$position == 'goalkeeper'] = 'def_gk'
fifa_tst_scaled$position[fifa_tst_scaled$position == 'midfielder' | fifa_tst_scaled$position == 'forward'] = 'mid_for'

fifa_est_scaled$position = as.factor(fifa_est_scaled$position)
fifa_val_scaled$position = as.factor(fifa_val_scaled$position)
fifa_trn_scaled$position = as.factor(fifa_trn_scaled$position)
fifa_tst_scaled$position = as.factor(fifa_tst_scaled$position)
```



## Data Balance checking
```{r}
table(fifa_est$position) / nrow(fifa_est)
```

## Logistic regression
```{r}
glm_1 = glm(formula = position ~ ., data = fifa_est, family = binomial(link = 'logit'))
glm_2 = glm(formula = position ~ .^2, data = fifa_est, family = binomial(link = 'logit'))
glm_3 = glm(formula = position ~ poly(overall,2)+poly(age,2)+poly(international_reputation,2)+
            poly(finishing,2)+poly(long_passing,2)+poly(ball_control,2)+
            poly(sprint_speed,2)+poly(strength,2)+poly(interceptions,2)+
            poly(vision,2)+poly(sliding_tackle,2)+poly(gk_diving,2)+poly(crossing,2),data = fifa_est, family = binomial(link = 'logit'))
glm_4 = glm(formula = position ~ poly(overall,3)+poly(age,3)+poly(international_reputation,3)+
            poly(finishing,3)+poly(long_passing,3)+poly(ball_control,3)+
            poly(sprint_speed,3)+poly(strength,3)+poly(interceptions,3)+
            poly(vision,3)+poly(sliding_tackle,3)+poly(gk_diving,3)+poly(crossing,3),data = fifa_est, family = binomial(link = 'logit'))
```



```{r}
glm_1_estval = c(miss_class(ifelse(predict(glm_1,fifa_est,'response') < 0.5, 'def_gk','mid_for'), fifa_est$position),
                 miss_class(ifelse(predict(glm_1,fifa_val,'response') < 0.5, 'def_gk','mid_for'), fifa_val$position))
glm_2_estval = c(miss_class(ifelse(predict(glm_2,fifa_est,'response') < 0.5, 'def_gk','mid_for'), fifa_est$position),
                 miss_class(ifelse(predict(glm_2,fifa_val,'response') < 0.5, 'def_gk','mid_for'), fifa_val$position))
glm_3_estval = c(miss_class(ifelse(predict(glm_3,fifa_est,'response') < 0.5, 'def_gk','mid_for'), fifa_est$position),
                 miss_class(ifelse(predict(glm_3,fifa_val,'response') < 0.5, 'def_gk','mid_for'), fifa_val$position))
glm_4_estval = c(miss_class(ifelse(predict(glm_4,fifa_est,'response') < 0.5, 'def_gk','mid_for'), fifa_est$position),
                 miss_class(ifelse(predict(glm_4,fifa_val,'response') < 0.5, 'def_gk','mid_for'), fifa_val$position))


logreg_report = data.frame(glm_1_estval,glm_2_estval,glm_3_estval,glm_4_estval)
rownames(logreg_report) = c('Est','Val')
colnames(logreg_report) = c('glm1','glm2','glm3','glm4')
logreg_report
```
### plot
```{r}
logreg_report = melt(data.matrix(logreg_report))
colnames(logreg_report) = c('data_type', 'model', 'misclass')
ggplot(data = logreg_report, aes(x = model,y = misclass, group = data_type, color = data_type))+
  geom_point(size = 2)+geom_line(size = 0.75)
```

## LDA
```{r}
lda_1 = lda(formula = position ~ ., data = fifa_est)
lda_2 = lda(formula = position ~ .^2,data = fifa_est)
lda_3 = lda(formula = position ~ .,data = fifa_est,prior = c(0.5,0.5))
lda_4 = lda(formula = position ~ .^2,data = fifa_est,prior = c(0.5,0.5))
```

```{r}
lda_1_estval = c(miss_class(predict(lda_1,fifa_est)$class,fifa_est$position),
                 miss_class(predict(lda_1,fifa_val)$class, fifa_val$position))
lda_2_estval = c(miss_class(predict(lda_2,fifa_est)$class,fifa_est$position),
                 miss_class(predict(lda_2,fifa_val)$class, fifa_val$position))
lda_3_estval = c(miss_class(predict(lda_3,fifa_est)$class,fifa_est$position),
                 miss_class(predict(lda_3,fifa_val)$class, fifa_val$position))
lda_4_estval = c(miss_class(predict(lda_4,fifa_est)$class,fifa_est$position),
                 miss_class(predict(lda_4,fifa_val)$class, fifa_val$position))
```

```{r}
lda_report = data.frame(lda_1_estval, lda_2_estval, lda_3_estval, lda_4_estval)
colnames(lda_report) = c('lda_1','lda_2','lda_3','lda_4')
rownames(lda_report) = c('est','val')
lda_report
```

```{r}
lda_report = melt(data.matrix(lda_report))
colnames(lda_report) = c('data_type','model','misclass')

ggplot(data = lda_report,aes(x = model, y = misclass, group = data_type, color = data_type))+
  geom_point(size = 2)+
  geom_line(size = 0.75)
```
## qda
```{r}
qda_1 = qda(formula = position ~ .,
            data = fifa_est)
qda_1_estval = c(miss_class(predict(qda_1,fifa_est)$class,fifa_est$position),
                 miss_class(predict(qda_1,fifa_val)$class,fifa_val$position))
qda_2 = qda(formula = position ~ .^2,
            data = fifa_est)
qda_2_estval = c(miss_class(predict(qda_2,fifa_est)$class,fifa_est$position),
                 miss_class(predict(qda_2,fifa_val)$class,fifa_val$position))
qda_3 = qda(formula = position ~ .,
            data = fifa_est,
            prior = c(0.5,0.5))
qda_3_estval = c(miss_class(predict(qda_3,fifa_est)$class,fifa_est$position),
                 miss_class(predict(qda_3,fifa_val)$class,fifa_val$position))
qda_4 = qda(formula = position ~ .^2,
            data = fifa_est,
            prior = c(0.5,0.5))
qda_4_estval = c(miss_class(predict(qda_4,fifa_est)$class,fifa_est$position),
                 miss_class(predict(qda_4,fifa_val)$class,fifa_val$position))


qda_report = data.frame(qda_1_estval, qda_2_estval, qda_3_estval, qda_4_estval)
colnames(qda_report) = c('qda_1','qda_2','qda_3','qda_4')
rownames(qda_report) = c('est','val')
qda_report
```

```{r}
qda_report = melt(data.matrix(qda_report))
colnames(qda_report) = c('data_type','model','misclass')

ggplot(data = qda_report,aes(x = model, y = misclass, group = data_type, color = data_type))+
  geom_point(size = 2)+
  geom_line(size = 0.75)
```

## KNN

```{r}
k_list = seq(10,200,10)
knn_miss_class_val_list = list()
for (i in 1:length(k_list)){
  knn_model = knn3(formula = position ~., data = fifa_est, k=k_list[i])
  knn_miss_class_val_list[[i]] = miss_class(predict(knn_model,fifa_val,'class'),fifa_val$position)
}
knn_miss_class_val_list = unlist(knn_miss_class_val_list)

knn_miss_class_val_scaled_list = list()
for (i in 1:length(k_list)){
  knn_model = knn3(formula = position ~., data = fifa_est_scaled, k=k_list[i])
  knn_miss_class_val_scaled_list[[i]] = miss_class(predict(knn_model,fifa_val_scaled,'class'),fifa_val_scaled$position)
}
knn_miss_class_val_scaled_list = unlist(knn_miss_class_val_scaled_list)

knn_report = data.frame(knn_miss_class_val_list, knn_miss_class_val_scaled_list)
colnames(knn_report) = c('Val','Val_scaled')
rownames(knn_report) = c('k10','k20','k30','k40','k50',
                         'k60','k70','k80','k90','k100',
                         'k110','k120','k130','k140','k150',
                         'k160','k170','k180','k190','k200')
knn_report
```

```{r}
knn_report = melt(data.matrix(knn_report))
colnames(knn_report) = c('k','data_type','misclass')
ggplot(data = knn_report, aes(x = k, y = misclass, group = data_type, color = data_type))+
  geom_point(size = 2)+
  geom_line(size = 0.75)+
  scale_x_discrete(guide = guide_axis(angle =90))
```


## Decision tree
### cp =  0.001
```{r}
minsplit_list = seq(10,200,10)
cltr_miss_class_val_list = list()
cltr_miss_class_est_list = list()
for (i in 1:length(minsplit_list)){
    cltr_model = rpart(formula = position ~ ., data = fifa_est, cp = 0.001, minsplit = minsplit_list[i])
    cltr_miss_class_val_list[[i]] = miss_class(predict(cltr_model, fifa_val, type = 'class'),fifa_val$position)
    cltr_miss_class_est_list[[i]] = miss_class(predict(cltr_model, fifa_est, type = 'class'),fifa_est$position)
    }

cltr_report = data.frame(as.numeric(cltr_miss_class_est_list), as.numeric(cltr_miss_class_val_list))
colnames(cltr_report) = c('Est','Val')
rownames(cltr_report) = c('m10','m20','m30','m40','m50',
                         'm60','m70','m80','m90','m100',
                         'm110','m120','m130','m140','m150',
                         'm160','m170','m180','m190','m200')
cltr_report
```
### plot
```{r}
cltr_report = melt(data.matrix(cltr_report))
colnames(cltr_report) = c('minsplit', 'data_type', 'Misclass')

ggplot(data = cltr_report, aes(x=minsplit, y=Misclass, group=data_type, color=data_type))+
  geom_point(size = 2)+geom_line(size = 0.75)+
  scale_x_discrete(guide = guide_axis(angle =90))
```
### cp = 0.01
```{r}
minsplit_list = seq(10,200,10)
cltr_miss_class_val_list = list()
cltr_miss_class_est_list = list()
for (i in 1:length(minsplit_list)){
    cltr_model = rpart(formula = position ~ ., data = fifa_est, cp = 0.01, minsplit = minsplit_list[i])
    cltr_miss_class_val_list[[i]] = miss_class(predict(cltr_model, fifa_val, type = 'class'),fifa_val$position)
    cltr_miss_class_est_list[[i]] = miss_class(predict(cltr_model, fifa_est, type = 'class'),fifa_est$position)
    }

cltr_report = data.frame(as.numeric(cltr_miss_class_est_list), as.numeric(cltr_miss_class_val_list))
colnames(cltr_report) = c('Est','Val')
rownames(cltr_report) = c('m10','m20','m30','m40','m50',
                         'm60','m70','m80','m90','m100',
                         'm110','m120','m130','m140','m150',
                         'm160','m170','m180','m190','m200')
cltr_report
```

### plot
```{r}
cltr_report = melt(data.matrix(cltr_report))
colnames(cltr_report) = c('minsplit', 'data_type', 'Misclass')

ggplot(data = cltr_report, aes(x=minsplit, y=Misclass, group=data_type, color=data_type))+
  geom_point(size = 2)+geom_line(size = 0.75)+
  scale_x_discrete(guide = guide_axis(angle =90))
```

### cp = 0.1
```{r}
minsplit_list = seq(10,200,10)
cltr_miss_class_val_list = list()
cltr_miss_class_est_list = list()
for (i in 1:length(minsplit_list)){
    cltr_model = rpart(formula = position ~ ., data = fifa_est, cp = 0.1, minsplit = minsplit_list[i])
    cltr_miss_class_val_list[[i]] = miss_class(predict(cltr_model, fifa_val, type = 'class'),fifa_val$position)
    cltr_miss_class_est_list[[i]] = miss_class(predict(cltr_model, fifa_est, type = 'class'),fifa_est$position)
    }

cltr_report = data.frame(as.numeric(cltr_miss_class_est_list), as.numeric(cltr_miss_class_val_list))
colnames(cltr_report) = c('Est','Val')
rownames(cltr_report) = c('m10','m20','m30','m40','m50',
                         'm60','m70','m80','m90','m100',
                         'm110','m120','m130','m140','m150',
                         'm160','m170','m180','m190','m200')
cltr_report
```

### plot
```{r}
cltr_report = melt(data.matrix(cltr_report))
colnames(cltr_report) = c('minsplit', 'data_type', 'Misclass')

ggplot(data = cltr_report, aes(x=minsplit, y=Misclass, group=data_type, color=data_type))+
  geom_point(size = 2)+geom_line(size = 0.75)+
  scale_x_discrete(guide = guide_axis(angle =90))
```

```{r}
rpart.plot(rpart(formula = position ~ ., data = fifa_est, cp = 0.001, minsplit = 50))
```
## Naive Bayes
```{r}
nb_1 = naiveBayes(formula = position ~ .,
                  data = fifa_est)

nb_1_estval = c(miss_class(predict(nb_1,fifa_est),fifa_est$position),
                miss_class(predict(nb_1,fifa_val),fifa_val$position))
nb_1_estval

```
## Best fitted classifier

```{r}
glm= glm(formula = position ~ .^2, data = fifa_est, family = binomial(link = 'logit'))
glm_estval = c(miss_class(ifelse(predict(glm,fifa_est,'response') < 0.5, 'def_gk','mid_for'), fifa_est$position),
                 miss_class(ifelse(predict(glm,fifa_val,'response') < 0.5, 'def_gk','mid_for'), fifa_val$position)) 

nb = naiveBayes(formula = position ~ ., data = fifa_est)
nb_estval = c(miss_class(predict(nb,fifa_est),fifa_est$position),
              miss_class(predict(nb,fifa_val),fifa_val$position))
cltr = rpart(formula = position ~ ., data = fifa_est, cp = 0.001, minsplit = 50)
cltr_estval = c(miss_class(predict(cltr, fifa_est, type = 'class'),fifa_est$position),
                miss_class(predict(cltr, fifa_val, type = 'class'),fifa_val$position))
cltr1 = rpart(formula = position ~ ., data = fifa_est, cp = 0.001, minsplit = 20)
cltr1_estval = c(miss_class(predict(cltr1, fifa_est, type = 'class'),fifa_est$position),
                miss_class(predict(cltr1, fifa_val, type = 'class'),fifa_val$position))

knn = knn3(formula = position ~., data = fifa_est_scaled, k = 120)
knn_estval = c(miss_class(predict(knn,fifa_est_scaled,'class'),fifa_est_scaled$position),
               miss_class(predict(knn,fifa_val_scaled,'class'),fifa_val_scaled$position))

lda = lda(formula = position ~ .^2, data = fifa_est)
lda_estval = c(miss_class(predict(lda,fifa_est)$class,fifa_est$position),
               miss_class(predict(lda,fifa_val)$class, fifa_val$position))
qda = qda(formula = position ~ .,
            data = fifa_est)
qda_estval = c(miss_class(predict(qda,fifa_est)$class,fifa_est$position),
                 miss_class(predict(qda,fifa_val)$class,fifa_val$position))

classification_report = data.frame(glm_estval, nb_estval, cltr_estval,cltr1_estval,
                                   knn_estval, lda_estval,qda_estval)
colnames(classification_report) = c('glm','nb','tree','tree1','knn','lda','qda')
rownames(classification_report) = c('est','val')

classification_report
```

```{r}
classification_report = melt(data.matrix(classification_report))
colnames(classification_report) = c('data_type','model','misclass')

ggplot(data = classification_report, aes(x = model, y = misclass, group = data_type, color = data_type))+
  geom_point(size = 2)+
  geom_line(size = 0.75)
```
## Train Choosen model on train set and calculate misclassification on test set
```{r}
final_class_model = knn3(formula = position ~., data = fifa_trn_scaled, k = 120)
print(paste(c('Misclass_train',miss_class(predict(final_class_model,fifa_trn_scaled,'class'),fifa_trn_scaled$position),'Misclass_test',miss_class(predict(final_class_model,fifa_tst_scaled,'class'),fifa_tst_scaled$position))))
```

